name "dd-check-<%= name %>-software"
default_version "0.0.1"

require 'json'
dependency 'pip'
require_relative "<%= PROJECT_DIR %>/resources/datadog-integrations/validate_manifest"
integration_source_folder = '/<%= integrations_repo %>/<%= name %>'
integration_agent_folder = "#{install_dir}/3rd-party/<%= name %>"

build do
  # validate manifest.json
  manifest = JSON.parse(File.read("#{integration_source_folder}/manifest.json"))
  validate_manifest(manifest)

  # copy files
  mkdir "#{integration_agent_folder}"

  # The conf directory is different on every system
  if linux?
    conf_directory = "/etc/dd-agent/conf.d"
  elsif osx?
    conf_directory = "#{install_dir}/etc"
  elsif windows?
    conf_directory = "../../extra_package_files/EXAMPLECONFSLOCATION"
  end

  mkdir "#{conf_directory}/examples/"

  # Move config files to examples folder.
  if File.exists? "#{project_dir}/<%= name %>/conf.yaml.example"
    copy "#{integration_source_folder}/conf.yaml.example", "/etc/dd-agent/conf.d/examples/<%= name %>.yaml.example"
  end

  # If it is a default, we need to move it as a default
  if File.exists? "#{project_dir}/<%= name %>/conf.yaml.default"
    copy "#{integration_source_folder}/conf.yaml.default", "/etc/dd-agent/conf.d/examples/<%= name %>.yaml.default"
  end

  command "echo \"#{integration_agent_folder}/lib\" > #{install_dir}/embedded/lib/python2.7/site-packages/#{name}.pth"

  # We need to move all the important stuff over
  # The manifest and the readme are important to move over
  for file in ["check.py", "manifest.json", "requirements.txt", "README.md"]
    copy "#{integration_source_folder}/#{file}", "#{integration_agent_folder}/#{file}"
  end

  # install requirements
  install_cmd = "install --target=#{integration_agent_folder}/lib "
  # Only apply the constraints file if one exists
  if File.exists? #{install_dir}/agent/requirements.txt
    install_cmd += " -c #{install_dir}/agent/requirements.txt "
  end
  install_cmd += " -r #{integration_source_folder}/requirements.txt"
  pip install_cmd
end
