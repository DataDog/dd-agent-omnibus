<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" 
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <!-- This is how we include wxi files -->
  <?include "parameters.wxi" ?>

  <!--
    Id="*" is to enable upgrading. * means that the product ID will be autogenerated on each build.
    Name is made of localized product name and version number.
  -->
   <Product Id="*"
           Name="$(var.PackageName)"
           Language="1033"
           Version="$(var.VersionNumber)"
           Manufacturer="!(loc.ManufacturerName)"
           UpgradeCode="$(var.UpgradeCode)"
           Codepage="1252">

    
    <!--
      Define the minimum supported installer version (2.0).
      The install should be done for the whole machine not just the current user
    -->
    <Package Id="*"
             Keywords="Installer"
             Comments="Copyright 2015 Datadog, Inc."
             Description="Datadog $(var.Description)"
             Manufacturer="!(loc.ManufacturerName)"
             InstallerVersion="400"
             Languages="1033"
             InstallPrivileges="elevated"
             InstallScope="perMachine"
             Compressed="yes" />
  
    <Property Id="COREAGENT">
      <RegistrySearch Id="CoreAgentInstallDir" Root="HKLM" Name="InstallPath" Type="raw"
                      Key="SOFTWARE\Datadog\Datadog Agent"/>
    </Property>

    
    <Condition Message="$(var.PackageName) Requires the Datadog Agent">
      <![CDATA[Installed OR COREAGENT]]>
    </Condition>

    <!-- This removes entirely the previous version -->
    <Upgrade Id="$(var.UpgradeCode)">
        <UpgradeVersion OnlyDetect='no'
                        Property='PREVIOUSFOUND'
                        Minimum='1.0.0' IncludeMinimum='yes'
                        Maximum="$(var.DisplayVersionNumber)" IncludeMaximum='no'/>
    </Upgrade>


    <!-- No need to restart Windows after the installation -->
    <Property Id="MSIRESTARTMANAGERCONTROL" Value="Disable" />

    <!-- Make sure that we get rid of any older installation of the Agent -->
    <MajorUpgrade
      DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit." />

    <Media Id="1" Cabinet="agent.cab" EmbedCab="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="APPLICATIONROOTDIRECTORY" Name="Datadog">
          <Directory Id="INTEGRATIONSROOT" Name="Integrations">
            <Directory Id="PROJECTLOCATION" Name="$(var.IntegrationName)"> 
            </Directory>
          </Directory>
        </Directory>
      </Directory>
      <Directory Id="CommonAppDataFolder" SourceName="CommonAppData">
        <Directory Id="APPLICATIONDATADIRECTORY" Name="Datadog"/>
      </Directory>
    </Directory>


    <!-- Delete application when uninstalling -->
    <!--
      RemoveFolderEx requires that we "remember" the path for uninstall.
      Read the path value and set the APPLICATIONROOTDIRECTORY property with the value.
    -->
    <Property Id="PROJECTLOCATION">
      <RegistrySearch Key="SOFTWARE\Datadog\Datadog Agent\Integrations\$(var.IntegrationName)"
                      Root="HKLM"
                      Type="raw"
                      Id="APPLICATIONROOTDIRECTORY_REGSEARCH"
                      Name="InstallPath" />
    </Property>

    <DirectoryRef Id="PROJECTLOCATION">
      <Component Id="CleanupMainApplicationFolder" Guid="*">
        <!-- We need to use APPLICATIONROOTDIRECTORY variable here or RemoveFolderEx
             will not remove on "uninstall". -->
        <RegistryValue Root="HKLM"
                       Key="SOFTWARE\Datadog\Datadog Agent\Integrations\$(var.IntegrationName)"
                       Name="InstallPath"
                       Type="string"
                       Value="[PROJECTLOCATION]"/>
        <util:RemoveFolderEx On="uninstall" Property="PROJECTLOCATION"/>
      </Component>
    </DirectoryRef>

    <!-- Set the components defined in our fragment files that will be used for our feature  -->
    <Feature Id="MainApplication" Title="Datadog Agent" Level="1" ConfigurableDirectory="APPLICATIONROOTDIRECTORY">
      <ComponentGroupRef Id="ProjectDir" />
      <ComponentRef Id="CleanupMainApplicationFolder" />
    </Feature>

    <!-- UI Stuff: 100% Omnibus Generated -->
    <Icon Id="project.ico" SourceFile="Resources\assets\project_16x16.ico"/>
    <Property Id="ARPPRODUCTICON" Value="project.ico" />
    <Property Id="ARPHELPLINK" Value="https://datadoghq.com/" />
    <Property Id="WIXUI_INSTALLDIR" Value="<%= wix_install_dir %>" />

    <UIRef Id="ProjectUI_InstallDir"/>
    <UI Id="ProjectUI_InstallDir">
      <UIRef Id="WixUI_Minimal"/>
      <TextStyle Id="WixUI_Font_Normal_White" FaceName="Tahoma" Size="8" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Bigger_White" FaceName="Tahoma" Size="12" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Title_White" FaceName="Tahoma" Size="9" Bold="yes" Red="255" Green="255" Blue="255" />
    </UI>

    <WixVariable Id="WixUILicenseRtf" Value="Resources\assets\LICENSE.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="Resources\assets\dialog_background.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="Resources\assets\banner_background.bmp" />
  </Product>
</Wix>
