<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <!-- This is how we include wxi files -->
  <?include "parameters.wxi" ?>

  <!--
    Id="*" is to enable upgrading. * means that the product ID will be autogenerated on each build.
    Name is made of localized product name and version number.
  -->
  <Product Id="*" Name="!(loc.ProductName)" Language="1033"
    Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerName)" UpgradeCode="$(var.UpgradeCode)"
    Codepage="1252">

    <!--
      Define the minimum supported installer version (2.0).
      The install should be done for the whole machine not just the current user
    -->
    <Package Id="*" Keywords="Monitoring, Datadog, Agent, WMI" Comments="Copyright 2015 Datadog, Inc."
      Description="Datadog Agent v$(var.DisplayVersionNumber)" Manufacturer="!(loc.ManufacturerName)"
      InstallerVersion="100" Languages="1033" InstallPrivileges="elevated" Compressed="yes"
      InstallScope="perMachine" />

    <!-- Some custom properties of ours -->
    <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes" />
    <Property Id="MSIRESTARTMANAGERCONTROL" Value="Disable" />

    <!-- Major upgrade -->
    <Upgrade Id="$(var.UpgradeCode)">
      <UpgradeVersion Minimum="1.0.0.0" Maximum="99.0.0.0" IncludeMinimum="yes"
        IncludeMaximum="no" Property="PREVIOUSVERSIONSINSTALLED" />
    </Upgrade>

    <Media Id="1" Cabinet="agent.cab" EmbedCab="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="APPLICATIONROOTDIRECTORY" Name="Datadog">
<% hierarchy.each.with_index do |(name, id), index| -%>
          <%= '  '*index %><Directory Id="<%= id %>" Name="<%= name %>">
<% end -%>
<% hierarchy.keys.each.with_index do |_, index| -%>
          <%= '  '*(hierarchy.size - index-1) %></Directory>
<% end -%>
        </Directory>
      </Directory>

      <Directory Id="CommonAppDataFolder" SourceName="CommonAppData">
        <Directory Id="APPLICATIONDATADIRECTORY" Name="Datadog" />
      </Directory>

      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Datadog"/>
      </Directory>

    </Directory>

    <!-- Some commands to execute after a successfull installation of Datadpg-Agent -->
    <Binary Id="FindReplace" SourceFile="$(var.FindReplaceDir)\FindReplace.exe" />
    <CustomAction
        Id="ReplaceAPIKey"
        BinaryKey="FindReplace"
        ExeCommand='"[CommonAppDataFolder]\Datadog\datadog.conf" APIKEYHERE [APIKEY]'
        Execute="deferred"
        Return="check"
        Impersonate="no" />

    <CustomAction
        Id="ReplaceTags"
        BinaryKey="FindReplace"
        ExeCommand='"[CommonAppDataFolder]\Datadog\datadog.conf" "#tags: mytag0, mytag1" "tags: [TAGS]"'
        Execute="deferred"
        Return="check"
        Impersonate="no" />

    <CustomAction
        Id="ReplaceHostname"
        BinaryKey="FindReplace"
        ExeCommand='"[CommonAppDataFolder]\Datadog\datadog.conf" "#hostname: mymachine.mydomain" "hostname: [HOSTNAME]"'
        Execute="deferred"
        Return="check"
        Impersonate="no" />

    <CustomAction
        Id="LaunchApp"
        Directory="DIST"
        ExeCommand="[SystemFolder]cmd.exe /C start agent-manager.exe" />

    <InstallExecuteSequence>
      <RemoveExistingProducts Before="InstallInitialize" />
      <Custom Action="ReplaceAPIKey" Before="StartServices" />
      <Custom Action="ReplaceTags" Before="StartServices" />
      <Custom Action="ReplaceHostname" Before="StartServices" />
    </InstallExecuteSequence>

    <CustomAction Id="LaunchApplication"
                  Directory="DIST"
                  ExeCommand="[SystemFolder]cmd.exe /C start agent-manager.exe" />

    <!-- Let's ship our dist folder with the service and gui executables -->
    <DirectoryRef Id="PROJECTLOCATION">
      <Directory Id="DIST" Name="dist">
        <!-- Windows service declaration for Datadog Agent -->
        <Component Id="DATADOGAGENTSERVICE" Guid="BCFAD885-5C69-49D3-99CB-494D14E87AAE">
          <File Id="ddagent.exe" Name="ddagent.exe" Source="$(var.AgentSourceDir)\dist\ddagent.exe" Vital="yes"
            KeyPath="yes" DiskId="1"/>
          <ServiceInstall Id="ServiceInstaller" DisplayName="Datadog Agent"
            Description="Send metrics to Datadog" Name="DatadogAgent" ErrorControl="ignore"
            Start="auto" Type="ownProcess" Vital="yes" Interactive="no" Account="LocalSystem">
          </ServiceInstall>
          <ServiceControl Id="StartService" Name="DatadogAgent" Start="install" Stop="both"
            Remove="uninstall" Wait="no" />
        </Component>
      </Directory>
    </DirectoryRef>

    <!-- Datadog Agent specific directory definitions -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="05206095-f4a0-4bb7-9ebd-80c7488dd7f9">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Datadog Agent Manager"
                  Description="Manage your Datadog Agent"
                  Target="[DIST]agent-manager.exe"
                  WorkingDirectory="DIST"/>
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\Microsoft\Datadog" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="APPLICATIONDATADIRECTORY">
      <Component Id="datadog.conf" Guid="83461594-01AC-11E2-BE35-37EC6088709B" NeverOverwrite="yes" Permanent="yes">
        <File Id="datadog.conf" Name="datadog.conf" Source="$(var.InstallFiles)\datadog_win32.conf"></File>
      </Component>
      <Directory Id="checks.d" Name="checks.d">
        <Component Id="checks.d" Guid="92cbe7e0-e72c-42c4-9353-741d94b63495" NeverOverwrite="yes"
          Permanent="yes" SharedDllRefCount="no" KeyPath="no" Location="either" Win64="yes">
          <CreateFolder/>
        </Component>
      </Directory>
      <Directory Id="EXAMPLECONFSLOCATION" Name="conf.d">
        <Component Id="conf.d" Guid="54fcfacb-726b-46e3-a699-ec19258a24be" Permanent="yes"
          Win64="yes" Location="either" SharedDllRefCount="no" KeyPath="no" NeverOverwrite="yes">
          <CreateFolder/>
        </Component>
      </Directory>
      <Directory Id="logs" Name="logs">
        <Component Id="logs" Guid="e194d05a-6dc7-40be-a626-6a15b43c456b"
          SharedDllRefCount="no" KeyPath="no" NeverOverwrite="no" Permanent="no" Transitive="no"
          Win64="yes" Location="either">
          <CreateFolder/>
        </Component>
      </Directory>
    </DirectoryRef>

    <!-- Set the components defined in our fragment files that will be used for our feature  -->
    <Feature Id="MainApplication" Title="Datadog Agent" Level="1" ConfigurableDirectory="APPLICATIONROOTDIRECTORY">
      <ComponentRef Id="datadog.conf" />
      <ComponentRef Id="logs" />
      <ComponentRef Id="conf.d" />
      <ComponentRef Id="checks.d" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentGroupRef Id="ProjectDir" />
      <ComponentGroupRef Id="ExtraEXAMPLECONFSLOCATION" />
      <ComponentGroupRef Id="ExtraDIST" />
    </Feature>

    <!-- UI Stuff: 100% Omnibus Generated -->
    <Icon Id="project.ico" SourceFile="Resources\assets\project_16x16.ico"/>
    <Property Id="ARPPRODUCTICON" Value="project.ico" />
    <Property Id="ARPHELPLINK" Value="http://www.getchef.com/" />
    <Property Id="WIXUI_INSTALLDIR" Value="<%= wix_install_dir %>" />

    <UIRef Id="ProjectUI_InstallDir"/>
    <UI Id="ProjectUI_InstallDir">
      <UIRef Id="WixUI_FeatureTree"/>
      <TextStyle Id="WixUI_Font_Normal_White" FaceName="Tahoma" Size="8" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Bigger_White" FaceName="Tahoma" Size="12" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Title_White" FaceName="Tahoma" Size="9" Bold="yes" Red="255" Green="255" Blue="255" />
    </UI>

    <WixVariable Id="WixUILicenseRtf" Value="Resources\assets\LICENSE.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="Resources\assets\dialog_background.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="Resources\assets\banner_background.bmp" />

    <WixVariable Id="WixUIExclamationIco" Value="Resources\assets\project_32x32.ico" />
    <WixVariable Id="WixUIInfoIco" Value="Resources\assets\project_32x32.ico" />
    <WixVariable Id="WixUINewIco" Value="Resources\assets\project_16x16.ico" />
    <WixVariable Id="WixUIUpIco" Value="Resources\assets\project_16x16.ico" />
  </Product>
</Wix>
